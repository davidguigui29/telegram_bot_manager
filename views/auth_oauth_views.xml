<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="telegram_login_injection" inherit_id="auth_oauth.providers">
        <xpath expr="//div[hasclass('o_auth_oauth_providers')]" position="inside">


        <div class="text-center mt-2">
            <button type="button" 
                    id="tg_login_btn"
                    class="btn btn-info w-100" 
                    style="background-color: #54A9EB; border: none; color: white; display: none;">
                <i class="fa fa-telegram"></i> Fast Login with Telegram
            </button>

            <script src="https://telegram.org/js/telegram-web-app.js"></script>
            
            <script type="text/javascript">
                // 1. Initialize the WebApp
                const webApp = window.Telegram.WebApp;
                const loginBtn = document.getElementById('tg_login_btn');

                // 2. Only show the button if we are actually INSIDE a Telegram Mini App
                if (webApp.initData) {
                    loginBtn.style.display = 'block';
                    webApp.expand(); // Make the app full screen
                }

                loginBtn.onclick = function() {
                    // Send the initData (which is already signed by Telegram) to your Odoo backend
                    fetch('/auth_oauth/telegram/signin_ajax', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            "jsonrpc": "2.0",
                            "params": {
                                "initData": webApp.initData 
                            }
                        })
                    }).then(function(response) {
                        return response.json();
                    }).then(function(data) {
                        if (data.result &amp;&amp; data.result.status === "success") {
                            window.location.replace(data.result.redirect_url);
                        } else {
                            alert("Auth failed: " + (data.result ? data.result.message : "Unknown error"));
                        }
                    });
                };
            </script>
        </div>

        </xpath>
    </template>
</odoo>